<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lịch Sử Đơn Hàng - KHÁNH BÁN SUB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f3ff;
        }
        .status-pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pending { background-color: #ffedd5; color: #f97316; } /* Orange - Chờ */
        .status-processing { background-color: #dbeafe; color: #3b82f6; } /* Blue - Đang xử lý */
        .status-completed { background-color: #dcfce7; color: #10b981; } /* Green - Hoàn thành */
        .status-cancelled { background-color: #fee2e2; color: #ef4444; } /* Red - Hủy */
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl p-6 md:p-10 border-t-8 border-indigo-600">
        
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-indigo-700">
                <i class="fas fa-history mr-2"></i> Lịch Sử Đơn Hàng
            </h1>
            <div class="space-x-3">
                <button 
                    onclick="window.location.href='dvfb.html'" 
                    class="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-200"
                >
                    <i class="fas fa-plus mr-2"></i> Đặt Dịch Vụ Mới
                </button>
                <button 
                    onclick="window.location.href='trangchu.html'" 
                    class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200"
                >
                    <i class="fas fa-home mr-2"></i> Trang Chủ
                </button>
            </div>
        </div>

        <div id="dataContainer">
            <p id="noDataMessage" class="text-center text-gray-500 text-lg p-10 hidden">
                <i class="fas fa-box-open mr-2"></i> Bạn chưa có đơn hàng nào.
            </p>

            <div class="overflow-x-auto">
                <table id="orderTable" class="min-w-full bg-white hidden table-fixed">
                    <thead>
                        <tr class="bg-indigo-50 text-indigo-700 text-left text-sm font-semibold uppercase tracking-wider">
                            <th class="py-3 px-4 w-1/12">ID</th>
                            <th class="py-3 px-4 w-2/12">Dịch Vụ</th>
                            <th class="py-3 px-4 w-1/12 text-center">SL</th>
                            <th class="py-3 px-4 w-2/12 text-right">Tổng Tiền</th>
                            <th class="py-3 px-4 w-2/12">Trạng Thái</th>
                            <th class="py-3 px-4 w-3/12">Link & Ngày Đặt</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            
            <div class="mt-6 text-right">
                <button 
                    onclick="clearHistory()" 
                    id="clearButton"
                    class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-200 disabled:opacity-50"
                    disabled
                >
                    <i class="fas fa-trash-alt mr-2"></i> Xóa Lịch Sử
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Lấy class CSS cho trạng thái
         */
        function getStatusClass(status) {
            if (status.includes('thanh toán')) return 'status-pending';
            if (status.includes('Hoàn thành')) return 'status-completed';
            if (status.includes('Hủy')) return 'status-cancelled';
            return 'status-processing';
        }

        /**
         * Tải dữ liệu đơn hàng từ LocalStorage và hiển thị lên bảng.
         */
        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const tableBody = document.getElementById('orderTableBody');
            const table = document.getElementById('orderTable');
            const noData = document.getElementById('noDataMessage');
            const clearButton = document.getElementById('clearButton');

            tableBody.innerHTML = '';
            
            if (orders.length === 0) {
                table.classList.add('hidden');
                noData.classList.remove('hidden');
                clearButton.disabled = true;
            } else {
                table.classList.remove('hidden');
                noData.classList.add('hidden');
                clearButton.disabled = false;

                orders.forEach((order) => {
                    const row = tableBody.insertRow();
                    row.className = 'hover:bg-indigo-50 transition duration-150 text-sm';

                    // Cột ID
                    row.insertCell().innerHTML = `<span class="font-bold text-indigo-600">${order.id.split('-')[1]}</span>`;

                    // Cột Dịch Vụ
                    row.insertCell().textContent = order.service + (order.emotion ? ` (${order.emotion})` : '');
                    
                    // Cột Số Lượng
                    row.insertCell().textContent = order.quantity.toLocaleString();
                    row.cells[2].className = 'py-3 px-4 text-center font-medium';

                    // Cột Tổng Tiền
                    row.insertCell().textContent = order.total.toLocaleString() + ' VNĐ';
                    row.cells[3].className = 'py-3 px-4 text-right font-bold text-rose-500';

                    // Cột Trạng Thái
                    row.insertCell().innerHTML = `<span class="status-pill ${getStatusClass(order.status)}">${order.status}</span>`;
                    
                    // Cột Link & Ngày Đặt
                    row.insertCell().innerHTML = `
                        <p class="text-xs text-gray-500">${order.date}</p>
                        <a href="${order.link}" target="_blank" class="text-xs text-blue-500 hover:underline truncate block max-w-[100px]">${order.link.substring(0, 30)}...</a>
                    `;
                });
            }
        }

        /**
         * Xóa toàn bộ lịch sử đơn hàng
         */
        function clearHistory() {
            if (confirm("Bạn có chắc chắn muốn XÓA TOÀN BỘ lịch sử đơn hàng không?")) {
                localStorage.removeItem('orders');
                alert("Lịch sử đã được xóa.");
                loadOrders(); 
            }
        }

        // Tải dữ liệu khi trang được mở
        window.onload = loadOrders;
    </script>
</body>
</html>