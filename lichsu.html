<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LUCKY SPIN | KHÁNH BÁN SUB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@300;500;900&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root { --accent: #00f2ff; --bg: #030303; --border: rgba(0, 242, 255, 0.2); }
        body { font-family: "Inter", sans-serif; background: var(--bg); color: white; min-height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .font-special { font-family: "Syncopate", sans-serif; }
        
        .laser-grid {
            position: fixed; inset: 0;
            background-image: linear-gradient(to right, rgba(0, 242, 255, 0.05) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px; perspective: 1000px;
            transform: rotateX(60deg) translateY(-100px); z-index: -1;
            mask-image: linear-gradient(to bottom, transparent, black 50%, transparent);
        }

        .wheel-box { position: relative; width: 320px; height: 320px; margin-bottom: 30px; }
        @media (min-width: 768px) { .wheel-box { width: 450px; height: 450px; } }

        #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; border: 10px solid #111; box-shadow: 0 0 50px rgba(0, 242, 255, 0.1); transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 40px; z-index: 20; filter: drop-shadow(0 0 10px var(--accent)); }
        
        .btn-main { background: var(--accent); color: black; font-weight: 900; padding: 15px 40px; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%); transition: 0.4s; text-transform: uppercase; font-size: 12px; letter-spacing: 2px; }
        .btn-main:hover:not(:disabled) { box-shadow: 0 0 30px var(--accent); transform: scale(1.05); }
        .btn-main:disabled { background: #222; color: #555; cursor: not-allowed; }

        .btn-home { position: fixed; top: 20px; left: 20px; color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 2px; border: 1px solid rgba(255,255,255,0.1); padding: 8px 15px; transition: 0.3s; }
        .btn-home:hover { color: var(--accent); border-color: var(--accent); }

        #claim-section { display: none; margin-top: 20px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #countdown { font-family: monospace; color: #ff3e3e; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="laser-grid"></div>

    <a href="trangchu.html" class="btn-home font-special"><i class="fas fa-arrow-left mr-2"></i> Trang Chủ</a>

    <div class="flex flex-col items-center w-full max-w-2xl px-4">
        <div class="text-center mb-8">
            <h1 class="font-special text-3xl md:text-5xl uppercase tracking-tighter mb-2">Lucky <span class="text-cyan-400">Spin</span></h1>
            <p id="status-text" class="text-[10px] text-gray-500 uppercase tracking-[0.4em]">Mỗi lượt cách nhau 24 giờ</p>
        </div>

        <div class="wheel-box">
            <img src="https://cdn-icons-png.flaticon.com/512/8213/8213522.png" class="pointer" />
            <canvas id="wheel-canvas" width="500" height="500"></canvas>
        </div>

        <button id="spin-btn" onclick="spinNow()" class="btn-main font-special">Kích hoạt vòng quay</button>

        <div id="claim-section" class="text-center">
            <p id="reward-text" class="text-xl font-bold text-cyan-400 mb-6 font-mono uppercase"></p>
            <button onclick="claimReward()" class="btn-main bg-white hover:bg-cyan-400">
                <i class="fas fa-gift mr-2"></i> Nhận quà ngay
            </button>
        </div>

        <div id="lock-msg" class="hidden mt-6 text-center">
            <p class="text-red-500 font-special text-[10px] uppercase tracking-widest bg-red-500/10 p-4 border border-red-500/20">
                Bạn đã hết lượt quay hôm nay!
            </p>
            <div id="countdown" class="font-bold"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("wheel-canvas");
        const ctx = canvas.getContext("2d");
        const spinBtn = document.getElementById("spin-btn");
        const claimSection = document.getElementById("claim-section");
        const rewardText = document.getElementById("reward-text");
        const lockMsg = document.getElementById("lock-msg");
        const statusText = document.getElementById("status-text");
        const countdownDisplay = document.getElementById("countdown");

        const rewards = ["100 SUB FB", "50 LIKE TT", "300 VIEW TT", "MAY MẮN NHÉ", "50 SUB TT", "200 LIKE FB", "100 SHARE FB", "1000 VIEW TT"];
        const colors = ["#000000", "#00f2ff", "#000000", "#111111", "#000000", "#00f2ff", "#000000", "#111111"];
        let currentRotation = 0;
        let wonReward = "";

        window.onload = () => {
            drawWheel();
            checkSpinLimit();
        };

        function drawWheel() {
            const arc = Math.PI / (rewards.length / 2);
            for (let i = 0; i < rewards.length; i++) {
                const angle = i * arc;
                ctx.beginPath();
                ctx.fillStyle = colors[i];
                ctx.moveTo(250, 250);
                ctx.arc(250, 250, 250, angle, angle + arc);
                ctx.fill();
                ctx.save();
                ctx.translate(250, 250);
                ctx.rotate(angle + arc / 2);
                ctx.fillStyle = i % 2 === 0 ? "#00f2ff" : "#fff";
                ctx.font = "bold 16px Inter";
                ctx.fillText(rewards[i], 120, 10);
                ctx.restore();
            }
        }

        function checkSpinLimit() {
            const lastSpin = localStorage.getItem('lastSpinTimestamp');
            if (lastSpin) {
                const now = new Date().getTime();
                const diff = now - parseInt(lastSpin);
                const twentyFourHours = 24 * 60 * 60 * 1000;

                if (diff < twentyFourHours) {
                    showLocked(twentyFourHours - diff);
                    return true;
                }
            }
            return false;
        }

        function showLocked(msRemaining) {
            spinBtn.disabled = true;
            spinBtn.style.display = "none";
            lockMsg.classList.remove('hidden');
            
            // Cập nhật đếm ngược mỗi giây
            const timer = setInterval(() => {
                msRemaining -= 1000;
                if (msRemaining <= 0) {
                    clearInterval(timer);
                    location.reload(); // Reset để quay lại trạng thái có thể quay
                }
                const h = Math.floor(msRemaining / 3600000);
                const m = Math.floor((msRemaining % 3600000) / 60000);
                const s = Math.floor((msRemaining % 60000) / 1000);
                countdownDisplay.innerText = `Lượt mới sau: ${h}h ${m}m ${s}s`;
            }, 1000);
        }

        function spinNow() {
            if (checkSpinLimit()) return;
            
            spinBtn.disabled = true;
            statusText.innerText = "ĐANG PHÂN TÍCH QUỸ ĐẠO...";

            const spinAdd = Math.floor(Math.random() * 360) + 3600; 
            currentRotation += spinAdd;
            canvas.style.transform = `rotate(${currentRotation}deg)`;

            setTimeout(() => {
                const actualDeg = currentRotation % 360;
                const rewardIndex = Math.floor((360 - actualDeg) / (360 / rewards.length)) % rewards.length;
                wonReward = rewards[rewardIndex];

                spinBtn.style.display = "none";
                rewardText.innerText = "BẠN TRÚNG: " + wonReward;
                
                // Lưu thời gian quay ngay lập tức
                localStorage.setItem('lastSpinTimestamp', new Date().getTime().toString());

                if(wonReward !== "MAY MẮN NHÉ") {
                    claimSection.style.display = "block";
                } else {
                    statusText.innerText = "HẸN GẶP LẠI SAU 24 GIỜ!";
                    setTimeout(() => location.href = "trangchu.html", 3000);
                }
            }, 5000);
        }

        function claimReward() {
            let history = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            history.unshift({
                platform: "GIFT",
                service: "Vòng Quay May Mắn",
                id: 'SPIN' + Math.floor(Math.random() * 9999),
                link: "Quà tặng 24h",
                quantity: "1",
                total: wonReward,
                status: 'CHỜ NHẬN',
                date: new Date().toLocaleString('vi-VN')
            });
            localStorage.setItem('orderHistory', JSON.stringify(history));
            
            alert("Đã lưu quà. Hãy chụp ảnh lịch sử và gửi cho Admin!");
            window.location.href = "adminnhanqua.html";
        }
    </script>
</body>
</html>